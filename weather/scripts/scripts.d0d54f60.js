"use strict";angular.module("weatherApp",["ngResource","ngRoute","ngCookies"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html"}).when("/:locationName",{templateUrl:"views/main.html"}).when("/id/:locationId",{templateUrl:"views/main.html"}).when("/coordinates/:lat/:lon",{templateUrl:"views/main.html"})}]),angular.module("weatherApp").controller("SinglecityCtrl",["$scope","$resource","units","prefferences","$routeParams","notice","requestprocessor",function(a,b,c,d,e,f,g){function h(){k(function(){c.getTimezone({lat:a.lat,lon:a.lon},function(b){a.timezone=b,a.UTCoffset=b.rawOffset},j)}),l()}function i(){e.locationName?(a.name=e.locationName,g.nameLoad(a.name,h)):e.lat&&e.lon?(a.lat=e.lat,a.lon=e.lon,g.coordinatesLoad(a.lat,a.lon,h)):e.locationId?(a.id=e.locationId,g.idLoad(a.id,h)):g.defaultLoad(h)}function j(){f.title="Ooops ...",f.description="It appears that we have no idea what the weather is. We'll try to figure it out, come back to us later!",f.actions=[],f.visible=!0}function k(b){var c=m.get(g.parameters,function(){a.id=c.id,a.temperature=c.main.temp,a.lat=c.coord.lat,a.lon=c.coord.lon,a.name=c.name,a.humidity=c.main.humidity,a.pressure=c.main.pressure,a.country=c.sys.country,a.visibility=c.visibility,a.description=c.weather[0].description,a.word=c.weather[0].main,a.icon=c.weather[0].icon,a.windDegrees=c.wind.deg,a.windSpeed=c.wind.speed,a.cloudiness=c.clouds.all,b()},j)}function l(){var b=n.get(g.parameters,function(){a.forecast=b.list},j)}a.temperature=0,a.forecast=[],a.getUnit=d.getUnit,a.getGeekMode=d.getGeekMode,a.UTCoffset=0,a.homeButtonValue=function(){return d.getHome()===a.id?"Home location":"Set as home"},a.favoriteButtonValue=function(){return d.isFavorite(a.id)?"★":"☆"},a.homeButtonClass=function(){return d.getHome()===a.id?"active":""},a.favoriteButtonClass=function(){return d.isFavorite(a.id)?"active":""},a.toggleFavoriteState=function(){d.toggleFavoriteState(a.id,a.name,a.country)},a.setHome=function(){var b=function(){f.close()};if(d.getHome()!==a.id){var c=function(){d.setHome(a.id),f.close()};f.title="Do you want to set "+a.name+" as the default location?",f.description="This means that whenever you visit this page "+a.name+" will be the one you see.",f.actions=[{name:"Yes",action:c},{name:"No",action:b}],f.visible=!0}else{var c=function(){d.setHome(!1),f.close()};f.title="Do you want for "+a.name+" to no longer be your home location?",f.description="This means that we will load weather for your coodinates or a default location, whenever you visit this page.",f.actions=[{name:"Yes",action:c},{name:"No",action:b}],f.visible=!0}};var m=b("//api.openweathermap.org/data/2.5/weather"),n=b("//api.openweathermap.org/data/2.5/forecast");i()}]),angular.module("weatherApp").value("apiKey","d82bc375d9b734d46a5e72ede7b989fe"),angular.module("weatherApp").service("units",["$resource","timezoneApiKey",function(a,b){var c=a("//api.geonames.org/timezoneJSON?lat=:lat&lng=:lon&username="+b),d=function(a,b,d){var e=c.get(a,function(){b(e)},d)};return{getTimezone:d}}]),angular.module("weatherApp").controller("PrefferencesCtrl",["$scope","prefferences","$location",function(a,b,c){a.setCelsius=b.setCelsius,a.setFarenheit=b.setFarenheit,a.toggleGeekMode=b.toggleGeekMode,a.starred=b.getStarred,a.goToId=function(b){a.toggleStarredList(),c.path("/id/"+b)},a.starredListStatus="contracted",a.toggleStarredList=function(){"expanded"===a.starredListStatus?a.starredListStatus="contracted":a.starredListStatus="expanded"},a.displayStarredList=function(){return Object.keys(a.starred()).length>0?!0:!1}}]),angular.module("weatherApp").service("prefferences",["$cookies",function(a){var b="weatherAppPrefferences",c={},d={unit:"C",geek:!1,home:!1,starred:{}},e=function(){c.unit="C",j()},f=function(){c.unit="F",j()},g=function(a){c.home=a,j()},h=function(){return c.unit},i=function(){return c.home?c.home:!1},j=function(){a.putObject(b,c,{expires:new Date((new Date).getTime()+31536e6)})},k=function(){c.geek=!c.geek,j()},l=function(){return c.geek?c.geek:!1},m=function(){return c.starred},n=function(a,b,d){c.starred[a]?delete c.starred[a]:c.starred[a]={name:b,country:d,id:a},j()},o=function(a){return!!c.starred[a]},p=a.getObject(b);if(p)for(var q in d)p[q]&&(d[q]=p[q]);return c=d,{getUnit:h,setHome:g,getHome:i,getGeekMode:l,toggleGeekMode:k,setCelsius:e,setFarenheit:f,toggleFavoriteState:n,isFavorite:o,getStarred:m}}]),angular.module("weatherApp").constant("timezoneApiKey","kazimieras"),angular.module("weatherApp").filter("temperature",function(){return function(a,b){return"F"===b?Math.round(1.8*(a-273)+32)+"°"+b:"C"===b?Math.round(a-273)+"°"+b:Math.round(a)+"K"}}),angular.module("weatherApp").filter("time",function(){return function(a,b){return new Date(1e3*(a+3600*b))}}),angular.module("weatherApp").directive("cloudcover",function(){return{template:'<canvas class="cloudcover" width="50" height="50"></canvas>',restrict:"E",link:function(a,b,c){function d(a){var c=b[0].children[0].getContext("2d");c.clearRect(0,0,50,50),isNaN(parseInt(a))||(c.fillStyle="rgb(54,54,54)",c.strokeStyle="rgb(54,54,54)",c.beginPath(),parseInt(a)>0?(c.moveTo(25,25),c.arc(25,25,25,0,360*(a/100)*(Math.PI/180),!1),c.fill()):(c.arc(25,25,25,0,2*Math.PI),c.stroke()))}c.$observe("percentage",d)}}}),angular.module("weatherApp").directive("winddirection",function(){return{template:'<canvas class="windDirection" width="50" height="50"></canvas>',restrict:"E",link:function(a,b,c){function d(a){if(!isNaN(parseInt(a))){var c=b[0].children[0].getContext("2d");c.clearRect(0,0,50,50),c.fillStyle="rgb(54,54,54)",c.strokeStyle="rgb(54,54,54)";var d=50,e=50,f=10,g=10;c.save(),c.translate(e/2,d/2),c.rotate(Math.PI/180*parseInt(a)),c.translate(-e/2,-d/2),c.moveTo(e/2,0),c.lineTo(e/2,d-g),c.stroke(),c.beginPath(),c.moveTo(e/2-f/2,d-g),c.lineTo(e/2+f/2,d-g),c.lineTo(e/2,d),c.fill(),c.restore()}}c.$observe("direction",d)}}}),angular.module("weatherApp").controller("HeaderCtrl",["$scope","requestprocessor","$location",function(a,b,c){a.visibility=!1,a.toggleMenu=function(){a.visibility=!a.visibility},a.coordinatesSeek=function(){b.deviceLocationLoad()},a.keyword="",a.performSearch=function(){a.toggleMenu(),0!==a.keyword.length&&c.path("/"+a.keyword)}}]),angular.module("weatherApp").filter("titlecaps",function(){return function(a){return a?a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}):void 0}}),angular.module("weatherApp").filter("forecastHours",function(){return function(a){return a.getHours()+":00"}}),angular.module("weatherApp").filter("forecastDay",function(){return function(a){var b=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return b[a.getDay()]+" "+(a.getMonth()+1)+"-"+a.getDate()}}),angular.module("weatherApp").controller("NoticeCtrl",["$rootScope","$scope","notice",function(a,b,c){function d(){b.visible=c.visible,b.title=c.title,b.description=c.description,b.actions=c.actions}b.$watch(function(){return c.visible},d,!0)}]),angular.module("weatherApp").factory("notice",function(){var a={};return a.visible=!1,a.title="",a.description="",a.actions=[],a.close=function(){a.visible=!1},a}),angular.module("weatherApp").service("requestprocessor",["$rootScope","prefferences","apiKey","$location",function(a,b,c,d){function e(){delete f.parameters.q,delete f.parameters.lat,delete f.parameters.lon,delete f.parameters.id}var f={};return f.parameters={APPID:c},f.nameLoad=function(a,b){e(),f.parameters.q=a,b()},f.coordinatesLoad=function(a,b,c){e(),f.parameters.lat=a,f.parameters.lon=b,c()},f.idLoad=function(a,b){e(),f.parameters.id=a,b()},f.deviceLocationLoad=function(){function b(b){d.path("/coordinates/"+b.coords.latitude+"/"+b.coords.longitude),a.$apply()}function c(a){console.warn("ERROR("+a.code+"): "+a.message)}var e={timeout:5e3,maximumAge:0};navigator.geolocation.getCurrentPosition(b,c,e)},f.defaultLoad=function(a){var c=b.getHome();return c?(f.parameters.id=c,a()):(f.deviceLocationLoad(),f.parameters.id="2643743",a())},f}]),angular.module("weatherApp").directive("hourlyGraph",function(){return{template:"<div></div>",restrict:"E",scope:{forecast:"=forecast",offset:"=offset"},link:function(a,b,c){function d(a,b){return"F"===b?Math.round(1.8*(a-273)+32):"C"===b?Math.round(a-273):void 0}function e(){if(0===h.length)return!1;var a,c,d={top:50,right:50,bottom:50,left:50};c=window.innerHeight<=window.innerWidth?2/3*window.innerHeight-d.top-d.bottom:2/3*window.innerWidth-d.top-d.bottom,window.innerWidth<=500?(a=window.innerWidth-d.left-d.right,k=7):window.innerWidth<=1e3?(a=.8*window.innerWidth-d.left-d.right,k=5):(a=.5*window.innerWidth-d.left-d.right,k=3);var e=d3.select("body").append("div").style("position","absolute").style("padding","0 10px").style("background","white").style("opacity",0),f=d3.scale.linear().domain([d3.min(h)-5,d3.max(h)]).range([0,c]),l=d3.scale.ordinal().domain(d3.range(0,i.length)).rangeBands([0,a],.2),m=d3.scale.linear().domain([d3.min(h)-5,d3.max(h)]).range(["rgb(131,191,23)","rgb(241,93,88)"]);d3.select(b[0].children[0]).html(""),d3.select(b[0].children[0]).append("svg").attr("id","hourlyGraph").attr("width",a+d.left+d.right).attr("height",c+d.top+d.bottom).append("g").attr("transform","translate("+d.left+","+d.top+")").selectAll("rect").data(h).enter().append("rect").style("fill",function(a){return m(a)}).attr("width",l.rangeBand()).attr("height",function(a){return f(a)}).attr("x",function(a,b){return l(b)}).attr("y",function(a){return c-f(a)}).on("mouseover",function(a,b){e.transition().style("opacity",.9),e.html(a+"&deg;"+g+" on "+j[new Date(i[b]).getDay()]+" "+(new Date(i[b]).getMonth()+1)+"-"+new Date(i[b]).getDate()+" "+new Date(i[b]).getHours()+":00").style("left",d3.event.pageX+"px").style("top",d3.event.pageY-30+"px"),d3.select(this).style("opacity",.5)}).on("mouseout",function(){d3.select(this).style("opacity",1)});var n=d3.scale.linear().domain([d3.min(h)-5,d3.max(h)]).range([c,0]),o=d3.svg.axis().scale(n).orient("left").ticks(10),p=d3.select("svg#hourlyGraph").append("g");o(p),p.attr("transform","translate("+d.left+","+d.top+")"),p.selectAll("path").style({fill:"none",stroke:"rgb(54,54,54)"}),p.selectAll("line").style({stroke:"rgb(54,54,54)"});var q=d3.svg.axis().scale(l).orient("bottom").tickValues(l.domain().filter(function(a){return 0===a?!0:a%k===0?!0:!1})).tickFormat(function(a){return i[a]?new Date(i[a]).getHours()+":00":void 0}),r=d3.select("svg#hourlyGraph").append("g");q(r),r.attr("transform","translate("+d.left+","+(c+d.top)+")"),r.selectAll("path").style({fill:"none",stroke:"rgb(54,54,54)"}),r.selectAll("line").style({stroke:"rgb(54,54,54)"}),d3.select("svg#hourlyGraph").append("text").attr("x",10).attr("y",30).html("&deg;"+g)}function f(){h=[],i=[],g="C"===c.unit||"F"===c.unit?c.unit:"C";for(var b=0;b<a.forecast.length;b++)h.push(d(a.forecast[b].main.temp,g)),i.push(1e3*(a.forecast[b].dt+3600*a.offset));e()}var g,h=[],i=[],j=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],k=5;a.$watch(function(){return a.forecast+a.offset+c.unit},f),window.addEventListener("orientationchange",e,!0)}}});